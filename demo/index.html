<!DOCTYPE html>
<html>
<head>
    <title>BBC R&ampD Video Compositor</title>
</head>
<body>
    <script type="text/javascript" src="../dist/videocompositor.js"></script>
    <script type="text/javascript" src="./lib/three.min.js"></script>
    <script src="http://www.webglearth.com/v2/api.js"></script>
    <script type="text/javascript">
        var earth = undefined;
        window.onload = function () {


            var options = {atmosphere: true, center: [0, 0], zoom: 0};
            var earthDiv = document.getElementById("earth_div");
            earth = new WE.map('earth_div', options);
            earth.setZoom(5.4);
            WE.tileLayer('http://otile{s}.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.jpg', {
                subdomains: '1234',
                attribution: 'Tiles Courtesy of MapQuest'
            }).addTo(earth);
            earth.canvas.width = 1280;
            earth.canvas.height = 720;
            earthDiv.removeChild(earth.canvas);
            var prevEarthTime = null;
            requestAnimationFrame(function spinEarth(earthTime){
                var pos = earth.getPosition();
                var elapsed =0.001;
                if (prevEarthTime) elapsed =  earthTime - prevEarthTime;
                prevEarthTime = earthTime;
                earth.setCenter([pos[0],pos[1]+0.1*(elapsed/30)]);
                requestAnimationFrame(spinEarth);
            });


            /*function MediaSourceListener(){
                this.play = function() {
                    console.log("Listened Play");
                };
                this.pause = function() {
                    console.log("Listened Pause");
                };
                this.seek = function(time) {
                    console.log("Listened Seek", time);
                };
                this.load = function() {
                    console.log("Listened Load");
                };
                this.destroy = function(){
                    console.log("Listened Destroy");
                };
                this.render = function() {

                };
            };

            var testListener = new MediaSourceListener();*/



            /*
            * Set up the video compositor 
            */
            var canvas = document.getElementById('player-canvas');
            canvas.width = 640;
            canvas.height = 360;

            var videoCompositor = new VideoCompositor(canvas);


            var testImage = new Image();
            testImage.src = "/assets/image.jpg";

            var playlist = {
                "tracks":[
                    [
                        {type:"video", start:0, duration:4, src:"assets/wtf_greenscreen_fast.mp4", id:"greenscreen video", "volume":1.0}, 
                        {type:"video", sourceStart:4, start:4, duration:4, src:"assets/wtf_greenscreen_fast.mp4", id:"greenscreen video1", "volume":1.0}, 
                        {type:"video", start:10, sourceStart:27, duration:4, src:"assets/wtf_greenscreen_fast.mp4", id:"greenscreen video2", "volume":1.0},
                        {type:"video", start:18, sourceStart:127, duration:4, src:"assets/wtf_greenscreen_fast.mp4", id:"greenscreen video3", "volume":1.0}
                        ],
                    [{type:"image", start:0, duration:15, src:"assets/weather-plate.png", id:"6"}],
                    [{type:"canvas", start:0, duration:15, element:earth.canvas, id:"earth"}],
                    [{type:"image", start:0, duration:15, src:"assets/background.png", id:"bg"}]

                ],
                "effects":{
                    "greenscreen-filter":{
                        "inputs":["greenscreen video","greenscreen video1", "greenscreen video2", "greenscreen video3"],
                        "effect":VideoCompositor.Effects.GREENSCREEN
                    },
                    "texuretest-1":{
                        "inputs":["earth"],
                        "effect":{
                            fragmentShader:"\
                                precision mediump float;\
                                uniform sampler2D u_image;\
                                uniform sampler2D image;\
                                varying vec2 v_texCoord;\
                                varying float v_progress;\
                                varying float v_duration;\
                                void main(){\
                                    vec4 color0 = texture2D(u_image, v_texCoord);\
                                    vec4 color1 = texture2D(image, v_texCoord);\
                                    gl_FragColor = color1 + color0;\
                                }"
                        },
                        "parameters":{
                            "image": testImage
                        }
                    }
                }
            };

            //videoCompositor.registerMediaSourceListener("earth", testListener);


            var duration = VideoCompositor.calculatePlaylistDuration(playlist);
            console.log("Playlist Duration", duration);
            videoCompositor.playlist = playlist;
            //videoCompositor.play();

            var audioCtx = videoCompositor.getAudioContext();
            var videoAudioNode = videoCompositor.getAudioNodeForTrack(playlist.tracks[0]);
            var delayNode = audioCtx.createDelay();
            delayNode.delayTime.value = 0.5;
            videoAudioNode.gain.value = 0.2;
            videoAudioNode.connect(delayNode);
            videoAudioNode.connect(audioCtx.destination);
            delayNode.connect(audioCtx.destination);



            videoCompositor.addEventListener("seek", function(data){
                console.log("Current Time",data);
            }, false);
            
            videoCompositor.addEventListener("ended", function(data){
                console.log("Playlist Ended",data);
            }, false);

            /*
            * Wire the buttons into controlling the video compositor.
            */
            var playButton = document.getElementById("play-button");
            var pauseButton = document.getElementById("pause-button");
            var mst3000Button = document.getElementById("mst3000-button");
            playButton.onclick = function(){
                videoCompositor.play();
            };
            pauseButton.onclick = function(){
                videoCompositor.pause();
            };
            mst3000Button.onclick = function(){
                var mst3000Track = [];
                playlist.tracks.unshift([{type:"image", start:0, duration:15, src:"assets/mst3000.png", id:"7"}]);
            };


            /*
            * Create an interactive visualisation canvas.
            */
            var visualisationCanvas = document.getElementById("visualisation-canvas");
            visualisationCanvas.height = 20;
            visualisationCanvas.width = canvas.width;
            //Setup up a render function so we can update the playhead position.
            function render () {
                VideoCompositor.renderPlaylist(playlist, visualisationCanvas, videoCompositor.currentTime);            
                requestAnimationFrame(render);
            }
            requestAnimationFrame(render);
            //catch mouse events to we can scrub through the timeline.
            visualisationCanvas.addEventListener("mousedown", function(evt){
                var x;
                if (evt.x!= undefined){
                    x = evt.x - visualisationCanvas.offsetLeft;
                }else{
                    //Fix for firefox
                    x = evt.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;          
                }

                var secondsPerPixel = videoCompositor.duration / visualisationCanvas.width;
                videoCompositor.currentTime = secondsPerPixel*x;
                //videoCompositor.play();

            }, false);

        };
    </script>
    <canvas id="player-canvas"></canvas>
    <br>
    <canvas id="visualisation-canvas"></canvas>
    <br>
    <button id="play-button">Play</button>
    <button id="pause-button">Pause</button>
    <button id="mst3000-button">More MST3000</button>
    <br>
    <div id="earth_div"></div>

</body>
</html>