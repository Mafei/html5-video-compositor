var VideoCompositor=function(e){function t(i){if(r[i])return r[i].exports;var n=r[i]={exports:{},id:i,loaded:!1};return e[i].call(n.exports,n,n.exports,t),n.loaded=!0,n.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{"default":e}}function n(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e)){var r=[],i=!0,n=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);i=!0);}catch(u){n=!0,a=u}finally{try{!i&&s["return"]&&s["return"]()}finally{if(n)throw a}}return r}throw new TypeError("Invalid attempt to destructure non-iterable instance")}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e){v.push(e)}function s(e){void 0===y&&(y=e);for(var t=(e-y)/1e3,r=0;r<v.length;r++)v[r].update(t);y=e,requestAnimationFrame(s)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),c=r(1),l=i(c),f=r(3),h=i(f),d=r(4),p=i(d),v=[],y=void 0,g=new Map;g.set("video",l["default"]).set("image",h["default"]).set("canvas",p["default"]),s();var m=function(){function e(t){a(this,e),this._canvas=t,this._ctx=this._canvas.getContext("2d"),this._playing=!1,this._mediaSources=new Map,this._mediaSourcePreloadNumber=2,this._playlist=void 0,this._eventMappings=new Map,this._currentTime=0,this.duration=0,o(this)}return u(e,[{key:"play",value:function(){this._playing=!0;var e=new CustomEvent("play",{detail:{data:this._currentTime,instance:this}});this._canvas.dispatchEvent(e)}},{key:"pause",value:function(){this._playing=!1,this._mediaSources.forEach(function(e,t,r){e.pause()});var e=new CustomEvent("pause",{detail:{data:this._currentTime,instance:this}});this._canvas.dispatchEvent(e)}},{key:"addEventListener",value:function(e,t){this._eventMappings.has(e)?this._eventMappings.get(e).push(t):this._eventMappings.set(e,[t]),this._canvas.addEventListener(e,this._dispatchEvents,!1)}},{key:"_dispatchEvents",value:function(e){for(var t=0;t<e.detail.instance._eventMappings.get(e.type).length;t++)e.detail.instance._eventMappings.get(e.type)[t](e.detail.data)}},{key:"_getPlaylistStatusAtTime",value:function(e,t){for(var r=[],i=[],n=[],a=0;a<e.tracks.length;a++)for(var o=e.tracks[a],s=0;s<o.length;s++){var u=o[s],c=u.start+u.duration;t>c?n.push(u):t>u.start&&c>t?i.push(u):t<=u.start&&r.push(u)}return[r,i,n]}},{key:"_sortMediaSourcesByStartTime",value:function(e){return e.sort(function(e,t){return e.start-t.start}),e}},{key:"_loadMediaSource",value:function(e,t){switch(void 0===t&&(t=function(e){}),e.type){case"video":var r=new l["default"](e);r.onready=t,r.load(),this._mediaSources.set(e.id,r);break;case"image":var i=new h["default"](e);i.onready=t,i.load(),this._mediaSources.set(e.id,i);break;case"canvas":var n=new p["default"](e);n.onready=t,n.load(),this._mediaSources.set(e.id,n);break;default:throw{error:5,msg:"mediaSourceReference "+e.id+" has unrecognized type "+e.type,toString:function(){return this.msg}}}}},{key:"update",value:function(e){if(void 0!==this._playlist&&this._playing!==!1){var t=this._getPlaylistStatusAtTime(this._playlist,this._currentTime),r=n(t,3),i=r[0],a=r[1],o=r[2];if(i=this._sortMediaSourcesByStartTime(i),0===i.length&&0===a.length){this.pause();var s=new CustomEvent("ended",{detail:{data:this.currentTime,instance:this}});return this.currentTime=0,void this._canvas.dispatchEvent(s)}for(var u=0;u<this._mediaSourcePreloadNumber&&u!==i.length;u++)this._mediaSources.has(i[u].id)===!1&&this._loadMediaSource(i[u]);for(var c=0;c<o.length;c++){var l=o[c];if(this._mediaSources.has(l.id)){var f=this._mediaSources.get(l.id);f.destroy(),this._mediaSources["delete"](l.id)}}var h=this._canvas.width,d=this._canvas.height;a.reverse(),this._ctx.clearRect(0,0,h,d);for(var p=0;p<a.length;p++){var v=a[p].id,f=this._mediaSources.get(v);f.play(),this._ctx.drawImage(f.render(),0,0,h,d)}this._currentTime+=e}}},{key:"currentTime",set:function(e){console.log("Seeking to",e);var t=this._getPlaylistStatusAtTime(this._playlist,e),r=n(t,3),i=(r[0],r[1]);r[2];this._mediaSources.forEach(function(e,t,r){e.destroy()}),this._mediaSources.clear();for(var a=0;a<i.length;a++){var o=i[a].id;if(this._mediaSources.has(o)===!1){this._loadMediaSource(i[a]);var s=this._mediaSources.get(o);s.seek(e)}else this._mediaSources.get(o).seek(e)}this._currentTime=e;var u=new CustomEvent("seek",{detail:{data:e,instance:this}});this._canvas.dispatchEvent(u)},get:function(){return this._currentTime}},{key:"playlist",set:function(t){e.validatePlaylist(t),this.duration=e.calculatePlaylistDuration(t),this._playlist=t}}],[{key:"calculateTrackDuration",value:function(e){for(var t=0,r=0;r<e.length;r++){var i=e[r].start+e[r].duration;i>t&&(t=i)}return t}},{key:"calculatePlaylistDuration",value:function(t){for(var r=0,i=0;i<t.tracks.length;i++){var n=t.tracks[i],a=e.calculateTrackDuration(n);a>r&&(r=a)}return r}},{key:"validatePlaylist",value:function(e){for(var t=new Map,r=0;r<e.tracks.length;r++)for(var i=e.tracks[r],n=0;n<i.length;n++){var a=i[n];if(t.has(a.id))throw{error:1,msg:"MediaSourceReference "+a.id+" in track "+r+" has a duplicate ID.",toString:function(){return this.msg}};t.set(a.id,!0)}for(var r=0;r<e.tracks.length;r++)for(var i=e.tracks[r],n=0;n<i.length;n++){var a=i[n];if(void 0===a.id)throw{error:2,msg:"MediaSourceReference "+a.id+" in track "+r+" is missing a id property",toString:function(){return this.msg}};if(void 0===a.start)throw{error:2,msg:"MediaSourceReference "+a.id+" in track "+r+" is missing a start property",toString:function(){return this.msg}};if(void 0===a.duration)throw{error:2,msg:"MediaSourceReference "+a.id+" in track "+r+" is missing a duration property",toString:function(){return this.msg}};if(void 0===a.type)throw{error:2,msg:"MediaSourceReference "+a.id+" in track "+r+" is missing a type property",toString:function(){return this.msg}};if(void 0!=a.src&&void 0!=a.element)throw{error:2,msg:"MediaSourceReference "+a.id+" in track "+r+" has both a src and element, it must have one or the other",toString:function(){return this.msg}};if(void 0===a.src&&void 0===a.element)throw{error:2,msg:"MediaSourceReference "+a.id+" in track "+r+" has neither a src or an element, it must have one or the other",toString:function(){return this.msg}}}for(var r=0;r<e.tracks.length;r++)for(var i=e.tracks[r],o=0,n=0;n<i.length;n++){var a=i[n];if(a.start<o)throw{error:3,msg:"MediaSourceReferences "+a.id+" in track "+r+" starts before previous MediaSourceReference",toString:function(){return this.msg}};o=a.start}for(var r=0;r<e.tracks.length;r++)for(var i=e.tracks[r],s=void 0,n=0;n<i.length;n++){var a=i[n];if(void 0!==s){var u=s.start+s.duration,c=a.start;if(u>c)throw{error:4,msg:"Track MediaSourceReferences overlap. MediaSourceReference "+s.id+" in track "+r+" finishes after MediaSourceReference "+a.id+" starts.",toString:function(){return this.msg}}}else s=a}}},{key:"renderPlaylist",value:function(t,r,i){var n=r.getContext("2d"),a=r.width,o=r.height,s=o/t.tracks.length,u=e.calculatePlaylistDuration(t),c=a/u,l={video:"#a5a",image:"#5aa",canvas:"#aa5"};n.clearRect(0,0,a,o),n.fillStyle="#999";for(var f=0;f<t.tracks.length;f++)for(var h=t.tracks[f],d=0;d<h.length;d++){var p=h[d],v=p.duration*c,y=s,g=p.start*c,m=s*f;n.fillStyle=l[p.type],n.fillRect(g,m,v,y),n.fill()}void 0!==i&&(n.fillStyle="#000",n.fillRect(i*c,0,1,o))}}]),e}();t["default"]=m,e.exports=t["default"]},function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{"default":e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),s=function(e,t,r){for(var i=!0;i;){var n=e,a=t,o=r;s=c=u=void 0,i=!1,null===n&&(n=Function.prototype);var s=Object.getOwnPropertyDescriptor(n,a);if(void 0!==s){if("value"in s)return s.value;var u=s.get;return void 0===u?void 0:u.call(o)}var c=Object.getPrototypeOf(n);if(null===c)return void 0;e=c,t=a,r=o,i=!0}},u=r(2),c=i(u),l=function(e){function t(e){n(this,t),s(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e),this.sourceStart=0,void 0!==e.sourceStart&&(this.sourceStart=e.sourceStart)}return a(t,e),o(t,[{key:"play",value:function(){s(Object.getPrototypeOf(t.prototype),"play",this).call(this),this.element.play()}},{key:"seek",value:function(e){s(Object.getPrototypeOf(t.prototype),"seek",this).call(this,e),e-this.start<0||e>this.start+this.duration||(this.element.currentTime=e-this.start+this.sourceStart)}},{key:"pause",value:function(){s(Object.getPrototypeOf(t.prototype),"pause",this).call(this),this.element.pause()}},{key:"load",value:function(){if(s(Object.getPrototypeOf(t.prototype),"load",this).call(this))return this.element.currentTime=this.sourceStart,this.seek(0),this.ready=!0,void this.onready(this);this.element=document.createElement("video"),this.element.src=this.src,this.element.preload="auto",this.element.load();var e=this;this.element.addEventListener("loadeddata",function(){e.element.currentTime=e.sourceStart,e.seek(0),e.ready=!0,e.onready(this)},!1)}},{key:"render",value:function(){return this.element}},{key:"destroy",value:function(){this.element.pause(),s(Object.getPrototypeOf(t.prototype),"destroy",this).call(this)}}]),t}(c["default"]);t["default"]=l,e.exports=t["default"]},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),n=function(){function e(t){r(this,e),this.id=t.id,this.duration=t.duration,this.start=t.start,this.playing=!1,this.ready=!1,this.element,this.src,this.disposeOfElementOnDestroy=!1,void 0!==t.src?(this.disposeOfElementOnDestroy=!0,this.src=t.src):(this.disposeOfElementOnDestroy=!1,this.element=t.element,console.log("HAS ELEMENT"))}return i(e,[{key:"play",value:function(){this.playing=!0}},{key:"pause",value:function(){console.log("Pausing",this.id),this.playing=!1}},{key:"seek",value:function(e){}},{key:"isReady",value:function(){return this.ready}},{key:"load",value:function(){return console.log("Loading",this.id),void 0!==this.element?!0:!1}},{key:"destroy",value:function(){console.log("Destroying",this.id),this.disposeOfElementOnDestroy&&delete this.element}},{key:"render",value:function(e,t){}},{key:"onready",value:function(e){}}]),e}();t["default"]=n,e.exports=t["default"]},function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{"default":e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),s=function(e,t,r){for(var i=!0;i;){var n=e,a=t,o=r;s=c=u=void 0,i=!1,null===n&&(n=Function.prototype);var s=Object.getOwnPropertyDescriptor(n,a);if(void 0!==s){if("value"in s)return s.value;var u=s.get;return void 0===u?void 0:u.call(o)}var c=Object.getPrototypeOf(n);if(null===c)return void 0;e=c,t=a,r=o,i=!0}},u=r(2),c=i(u),l=function(e){function t(e){n(this,t),s(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e)}return a(t,e),o(t,[{key:"play",value:function(){s(Object.getPrototypeOf(t.prototype),"play",this).call(this)}},{key:"seek",value:function(e){s(Object.getPrototypeOf(t.prototype),"seek",this).call(this,e)}},{key:"pause",value:function(){s(Object.getPrototypeOf(t.prototype),"pause",this).call(this)}},{key:"load",value:function(){if(!s(Object.getPrototypeOf(t.prototype),"load",this).call(this)){this.element=new Image;var e=this;this.element.onload=function(){e.ready=!0,e.onready()},this.element.src=this.src}}},{key:"render",value:function(){return this.element}}]),t}(c["default"]);t["default"]=l,e.exports=t["default"]},function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{"default":e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),s=function(e,t,r){for(var i=!0;i;){var n=e,a=t,o=r;s=c=u=void 0,i=!1,null===n&&(n=Function.prototype);var s=Object.getOwnPropertyDescriptor(n,a);if(void 0!==s){if("value"in s)return s.value;var u=s.get;return void 0===u?void 0:u.call(o)}var c=Object.getPrototypeOf(n);if(null===c)return void 0;e=c,t=a,r=o,i=!0}},u=r(2),c=i(u),l=function(e){function t(e){n(this,t),s(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e),this.width=e.width,this.height=e.height}return a(t,e),o(t,[{key:"play",value:function(){s(Object.getPrototypeOf(t.prototype),"play",this).call(this)}},{key:"seek",value:function(e){s(Object.getPrototypeOf(t.prototype),"seek",this).call(this,e)}},{key:"pause",value:function(){s(Object.getPrototypeOf(t.prototype),"pause",this).call(this)}},{key:"load",value:function(){s(Object.getPrototypeOf(t.prototype),"load",this).call(this)||(this.element=document.createElement("canvas"),this.element.width=this.width,this.element.height=this.height,this.ready=!0,this.onready())}},{key:"render",value:function(){return this.element}}]),t}(c["default"]);t["default"]=l,e.exports=t["default"]}]);