var VideoCompositor=function(e){function t(i){if(r[i])return r[i].exports;var n=r[i]={exports:{},id:i,loaded:!1};return e[i].call(n.exports,n,n.exports,t),n.loaded=!0,n.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{"default":e}}function n(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e)){var r=[],i=!0,n=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done)&&(r.push(a.value),!t||r.length!==t);i=!0);}catch(u){n=!0,o=u}finally{try{!i&&s["return"]&&s["return"]()}finally{if(n)throw o}}return r}throw new TypeError("Invalid attempt to destructure non-iterable instance")}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e){v.push(e)}function s(e){void 0===y&&(y=e);for(var t=(e-y)/1e3,r=0;r<v.length;r++)v[r].update(t);y=e,requestAnimationFrame(s)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),l=r(1),c=i(l),h=r(3),d=i(h),f=r(4),p=i(f),v=[],y=void 0,g=new Map;g.set("video",c["default"]).set("image",d["default"]).set("canvas",p["default"]),s();var m=function(){function e(t){o(this,e),this._canvas=t,this._ctx=this._canvas.getContext("2d"),this._playing=!1,this._mediaSources=new Map,this._mediaSourcePreloadNumber=2,this._playlist=void 0,this._eventMappings=new Map,this._currentTime=0,this.duration=0,a(this)}return u(e,[{key:"play",value:function(){this._playing=!0;var e=new CustomEvent("play",{detail:{data:this._currentTime,instance:this}});this._canvas.dispatchEvent(e)}},{key:"pause",value:function(){this._playing=!1,this._mediaSources.forEach(function(e,t,r){e.pause()});var e=new CustomEvent("pause",{detail:{data:this._currentTime,instance:this}});this._canvas.dispatchEvent(e)}},{key:"addEventListener",value:function(e,t){this._eventMappings.has(e)?this._eventMappings.get(e).push(t):this._eventMappings.set(e,[t]),this._canvas.addEventListener(e,this._dispatchEvents,!1)}},{key:"_dispatchEvents",value:function(e){for(var t=0;t<e.detail.instance._eventMappings.get(e.type).length;t++)e.detail.instance._eventMappings.get(e.type)[t](e.detail.data)}},{key:"_getPlaylistStatusAtTime",value:function(e,t){for(var r=[],i=[],n=[],o=0;o<e.tracks.length;o++)for(var a=e.tracks[o],s=0;s<a.length;s++){var u=a[s],l=u.start+u.duration;t>l?n.push(u):t>u.start&&l>t?i.push(u):t<=u.start&&r.push(u)}return[r,i,n]}},{key:"_sortMediaSourcesByStartTime",value:function(e){return e.sort(function(e,t){return e.start-t.start}),e}},{key:"_loadMediaSource",value:function(e,t){switch(void 0===t&&(t=function(e){}),e.type){case"video":var r=new c["default"](e);r.onready=t,r.load(),this._mediaSources.set(e.id,r);break;case"image":var i=new d["default"](e);i.onready=t,i.load(),this._mediaSources.set(e.id,i);break;case"canvas":var n=new p["default"](e);n.onready=t,n.load(),this._mediaSources.set(e.id,n);break;default:throw{error:5,msg:"mediaSourceReference "+e.id+" has unrecognized type "+e.type,toString:function(){return this.msg}}}}},{key:"update",value:function(e){if(void 0!==this._playlist&&this._playing!==!1){var t=this._getPlaylistStatusAtTime(this._playlist,this._currentTime),r=n(t,3),i=r[0],o=r[1],a=r[2];if(i=this._sortMediaSourcesByStartTime(i),0===i.length&&0===o.length){this.pause();var s=new CustomEvent("ended",{detail:{data:this.currentTime,instance:this}});return this.currentTime=0,void this._canvas.dispatchEvent(s)}for(var u=0;u<this._mediaSourcePreloadNumber&&u!==i.length;u++)this._mediaSources.has(i[u].id)===!1&&this._loadMediaSource(i[u]);for(var l=0;l<a.length;l++){var c=a[l];if(this._mediaSources.has(c.id)){var h=this._mediaSources.get(c.id);h.destroy(),this._mediaSources["delete"](c.id)}}var d=this._canvas.width,f=this._canvas.height;o.reverse(),this._ctx.clearRect(0,0,d,f);for(var p=0;p<o.length;p++){var v=o[p].id;if(this._mediaSources.has(v)){var h=this._mediaSources.get(v);h.play(),this._ctx.drawImage(h.render(),0,0,d,f)}else this._loadMediaSource(o[p])}this._currentTime+=e}}},{key:"currentTime",set:function(e){if(console.log("Seeking to",e),void 0!==this._playlist){var t=this._getPlaylistStatusAtTime(this._playlist,e),r=n(t,3),i=(r[0],r[1]);r[2];this._mediaSources.forEach(function(e,t,r){e.destroy()}),this._mediaSources.clear();for(var o=0;o<i.length;o++){var a=i[o].id;if(this._mediaSources.has(a)===!1){this._loadMediaSource(i[o],function(t){console.log("READY",t),t.seek(e)})}else this._mediaSources.get(a).seek(e)}this._currentTime=e;var s=new CustomEvent("seek",{detail:{data:e,instance:this}});this._canvas.dispatchEvent(s)}},get:function(){return this._currentTime}},{key:"playlist",set:function(t){e.validatePlaylist(t),this.duration=e.calculatePlaylistDuration(t),this._playlist=t,this._mediaSources.forEach(function(e,t,r){e.destroy()}),this._mediaSources.clear()}}],[{key:"calculateTrackDuration",value:function(e){for(var t=0,r=0;r<e.length;r++){var i=e[r].start+e[r].duration;i>t&&(t=i)}return t}},{key:"calculatePlaylistDuration",value:function(t){for(var r=0,i=0;i<t.tracks.length;i++){var n=t.tracks[i],o=e.calculateTrackDuration(n);o>r&&(r=o)}return r}},{key:"validatePlaylist",value:function(e){for(var t=new Map,r=0;r<e.tracks.length;r++)for(var i=e.tracks[r],n=0;n<i.length;n++){var o=i[n];if(t.has(o.id))throw{error:1,msg:"MediaSourceReference "+o.id+" in track "+r+" has a duplicate ID.",toString:function(){return this.msg}};t.set(o.id,!0)}for(var r=0;r<e.tracks.length;r++)for(var i=e.tracks[r],n=0;n<i.length;n++){var o=i[n];if(void 0===o.id)throw{error:2,msg:"MediaSourceReference "+o.id+" in track "+r+" is missing a id property",toString:function(){return this.msg}};if(void 0===o.start)throw{error:2,msg:"MediaSourceReference "+o.id+" in track "+r+" is missing a start property",toString:function(){return this.msg}};if(void 0===o.duration)throw{error:2,msg:"MediaSourceReference "+o.id+" in track "+r+" is missing a duration property",toString:function(){return this.msg}};if(void 0===o.type)throw{error:2,msg:"MediaSourceReference "+o.id+" in track "+r+" is missing a type property",toString:function(){return this.msg}};if(void 0!=o.src&&void 0!=o.element)throw{error:2,msg:"MediaSourceReference "+o.id+" in track "+r+" has both a src and element, it must have one or the other",toString:function(){return this.msg}};if(void 0===o.src&&void 0===o.element)throw{error:2,msg:"MediaSourceReference "+o.id+" in track "+r+" has neither a src or an element, it must have one or the other",toString:function(){return this.msg}}}for(var r=0;r<e.tracks.length;r++)for(var i=e.tracks[r],a=0,n=0;n<i.length;n++){var o=i[n];if(o.start<a)throw{error:3,msg:"MediaSourceReferences "+o.id+" in track "+r+" starts before previous MediaSourceReference",toString:function(){return this.msg}};a=o.start}for(var r=0;r<e.tracks.length;r++)for(var i=e.tracks[r],s=void 0,n=0;n<i.length;n++){var o=i[n];if(void 0!==s){var u=s.start+s.duration,l=o.start;if(u>l)throw{error:4,msg:"Track MediaSourceReferences overlap. MediaSourceReference "+s.id+" in track "+r+" finishes after MediaSourceReference "+o.id+" starts.",toString:function(){return this.msg}}}else s=o}}},{key:"renderPlaylist",value:function(t,r,i){var n=r.getContext("2d"),o=r.width,a=r.height,s=a/t.tracks.length,u=e.calculatePlaylistDuration(t),l=o/u,c={video:"#a5a",image:"#5aa",canvas:"#aa5"};n.clearRect(0,0,o,a),n.fillStyle="#999";for(var h=0;h<t.tracks.length;h++)for(var d=t.tracks[h],f=0;f<d.length;f++){var p=d[f],v=p.duration*l,y=s,g=p.start*l,m=s*h;n.fillStyle=c[p.type],n.fillRect(g,m,v,y),n.fill()}void 0!==i&&(n.fillStyle="#000",n.fillRect(i*l,0,1,a))}}]),e}();t["default"]=m,e.exports=t["default"]},function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{"default":e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),s=function(e,t,r){for(var i=!0;i;){var n=e,o=t,a=r;s=l=u=void 0,i=!1,null===n&&(n=Function.prototype);var s=Object.getOwnPropertyDescriptor(n,o);if(void 0!==s){if("value"in s)return s.value;var u=s.get;return void 0===u?void 0:u.call(a)}var l=Object.getPrototypeOf(n);if(null===l)return void 0;e=l,t=o,r=a,i=!0}},u=r(2),l=i(u),c=function(e){function t(e){n(this,t),s(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e),this.sourceStart=0,void 0!==e.sourceStart&&(this.sourceStart=e.sourceStart)}return o(t,e),a(t,[{key:"play",value:function(){s(Object.getPrototypeOf(t.prototype),"play",this).call(this),this.element.play()}},{key:"seek",value:function(e){s(Object.getPrototypeOf(t.prototype),"seek",this).call(this,e),e-this.start<0||e>this.start+this.duration?this.element.currentTime=this.sourceStart:(console.log("Seeking  to mid point"),this.element.currentTime=e-this.start+this.sourceStart)}},{key:"pause",value:function(){s(Object.getPrototypeOf(t.prototype),"pause",this).call(this),this.element.pause()}},{key:"load",value:function(){if(console.log("Loading",this.id),s(Object.getPrototypeOf(t.prototype),"load",this).call(this))return this.seek(0),this.ready=!0,console.log("Calling On Ready",this,this.onready),void this.onready(this);this.element=document.createElement("video"),this.element.src=this.src,this.element.preload="auto",this.element.load();var e=this;this.element.addEventListener("loadeddata",function(){console.log("Loaded",this.id),e.element.currentTime=e.sourceStart,e.seek(0),e.ready=!0,console.log("Calling On Ready",e.id,e.onready),e.onready(e)},!1)}},{key:"render",value:function(){return this.element}},{key:"destroy",value:function(){this.element.pause(),s(Object.getPrototypeOf(t.prototype),"destroy",this).call(this)}}]),t}(l["default"]);t["default"]=c,e.exports=t["default"]},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),n=function(){function e(t){r(this,e),this.id=t.id,this.duration=t.duration,this.start=t.start,this.playing=!1,this.ready=!1,this.element,this.src,this.disposeOfElementOnDestroy=!1,void 0!==t.src?(this.disposeOfElementOnDestroy=!0,this.src=t.src):(this.disposeOfElementOnDestroy=!1,this.element=t.element)}return i(e,[{key:"play",value:function(){this.playing=!0}},{key:"pause",value:function(){console.log("Pausing",this.id),this.playing=!1}},{key:"seek",value:function(e){}},{key:"isReady",value:function(){return this.ready}},{key:"load",value:function(){return console.log("Loading",this.id),void 0!==this.element?!0:!1}},{key:"destroy",value:function(){console.log("Destroying",this.id),this.disposeOfElementOnDestroy&&delete this.element}},{key:"render",value:function(e,t){}},{key:"onready",value:function(e){}}]),e}();t["default"]=n,e.exports=t["default"]},function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{"default":e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),s=function(e,t,r){for(var i=!0;i;){var n=e,o=t,a=r;s=l=u=void 0,i=!1,null===n&&(n=Function.prototype);var s=Object.getOwnPropertyDescriptor(n,o);if(void 0!==s){if("value"in s)return s.value;var u=s.get;return void 0===u?void 0:u.call(a)}var l=Object.getPrototypeOf(n);if(null===l)return void 0;e=l,t=o,r=a,i=!0}},u=r(2),l=i(u),c=function(e){function t(e){n(this,t),s(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e)}return o(t,e),a(t,[{key:"play",value:function(){s(Object.getPrototypeOf(t.prototype),"play",this).call(this)}},{key:"seek",value:function(e){s(Object.getPrototypeOf(t.prototype),"seek",this).call(this,e)}},{key:"pause",value:function(){s(Object.getPrototypeOf(t.prototype),"pause",this).call(this)}},{key:"load",value:function(){if(s(Object.getPrototypeOf(t.prototype),"load",this).call(this))return this.seek(0),this.ready=!0,void this.onready(this);this.element=new Image;var e=this;this.element.onload=function(){e.ready=!0,e.onready(e)},this.element.src=this.src}},{key:"render",value:function(){return this.element}}]),t}(l["default"]);t["default"]=c,e.exports=t["default"]},function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{"default":e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),s=function(e,t,r){for(var i=!0;i;){var n=e,o=t,a=r;s=l=u=void 0,i=!1,null===n&&(n=Function.prototype);var s=Object.getOwnPropertyDescriptor(n,o);if(void 0!==s){if("value"in s)return s.value;var u=s.get;return void 0===u?void 0:u.call(a)}var l=Object.getPrototypeOf(n);if(null===l)return void 0;e=l,t=o,r=a,i=!0}},u=r(2),l=i(u),c=function(e){function t(e){n(this,t),s(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e),this.width=e.width,this.height=e.height}return o(t,e),a(t,[{key:"play",value:function(){s(Object.getPrototypeOf(t.prototype),"play",this).call(this)}},{key:"seek",value:function(e){s(Object.getPrototypeOf(t.prototype),"seek",this).call(this,e)}},{key:"pause",value:function(){s(Object.getPrototypeOf(t.prototype),"pause",this).call(this)}},{key:"load",value:function(){return s(Object.getPrototypeOf(t.prototype),"load",this).call(this)?(this.seek(0),this.ready=!0,void this.onready(this)):(this.element=document.createElement("canvas"),this.element.width=this.width,this.element.height=this.height,this.ready=!0,void this.onready(this))}},{key:"render",value:function(){return this.element}}]),t}(l["default"]);t["default"]=c,e.exports=t["default"]}]);